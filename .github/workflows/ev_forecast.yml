# Name for the GitHub Actions workflow
name: Monthly EV Demand Forecast CI/CD

on:
  # Schedule to run automatically on the 1st of every month at 02:30 UTC
  schedule:
    - cron: '30 2 1 * *'
  # Allows the workflow to be triggered manually from the GitHub Actions UI
  workflow_dispatch:

jobs:
  # The main job that runs the entire pipeline
  forecast-pipeline:
    # Use the latest version of Ubuntu as the runner environment
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # Step 1: Check out your repository code using a Personal Access Token (PAT)
      # This is required to grant the workflow permission to push changes back to your private repo.
      - name: '1. Checkout Repository'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ACTIONS_PAT }}

      # Step 2: Set up the Python environment
      - name: '2. Set up Python Environment'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' # Use a specific version of Python
          cache: 'pip'

      # Step 3: Install all necessary Python libraries for the project
      - name: '3. Install Project Dependencies'
        run: |
          python -m pip install --upgrade pip
          # Primary, pinned deps
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # Ensure CI has Excel + gradient boosting stacks used by advanced model
          pip install openpyxl scikit-learn xgboost catboost


      # Step 4: Build training data from manually added Excel via datapush preprocessing
      - name: '4. Preprocess Data (Datapush)'
        run: python scripts/run_pipeline.py --mode datapush

      # Debug: list data and output directories to verify files
      - name: '5. List data and output'
        run: |
          echo "== data =="
          ls -la data || true
          echo "== output =="
          ls -la output || true

      # Step 6: Prepare EV_Dataset.csv for trainer (map Vehicle_Class -> Vehicle_Category) with fallback
      - name: '6. Prepare Training Dataset'
        run: |
          python - << 'PY'
          import pandas as pd
          from pathlib import Path
          root = Path(__file__).resolve().parents[2]
          pre = root / 'output' / 'preprocessed_data.csv'
          out = root / 'data' / 'EV_Dataset.csv'
          fallback = root / 'data' / 'EV_Dataset.csv'
          if pre.exists():
              df = pd.read_csv(pre)
              print('Using output/preprocessed_data.csv')
          elif fallback.exists():
              df = pd.read_csv(fallback)
              print('Fallback to data/EV_Dataset.csv')
          else:
              raise SystemExit('No training data found: neither output/preprocessed_data.csv nor data/EV_Dataset.csv exists')
          # Ensure required columns for advanced trainer
          if 'Vehicle_Category' not in df.columns and 'Vehicle_Class' in df.columns:
              df['Vehicle_Category'] = df['Vehicle_Class']
          # Minimal column sanity
          required = ['Date','State','Vehicle_Category','EV_Sales_Quantity']
          missing = [c for c in required if c not in df.columns]
          if missing:
              raise SystemExit(f'Missing required columns for training: {missing}')
          out.parent.mkdir(exist_ok=True)
          df.to_csv(out, index=False)
          print(f'Wrote training dataset to {out}')
          PY

      # Step 7: Train the advanced model on the latest data
      - name: '7. Train Advanced Model'
        run: python scripts/advanced_model_trainer.py

      # Step 8: Optionally retrain baseline model for back-compat (non-blocking)
      - name: '8. (Optional) Retrain Baseline Model'
        run: |
          python scripts/demand_forecast.py || echo "Baseline model training skipped"

      # Step 9: Commit the newly trained model files back to the repository
      - name: '9. Commit New Models'
        run: |
          # Configure git with a bot user name and email
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions-bot@github.com'
          # Add new/updated model artifacts to the staging area
          git add models/advanced_ev_model.pkl models/feature_names.pkl models/feature_scaler.pkl || true
          git add models/ev_model.pkl || true
          # Check if there are any changes to commit to avoid empty commits
          # The "|| git commit" part means the commit command only runs if the diff command fails (i.e., finds changes)
          git diff --staged --quiet || git commit -m "Auto-update: retrained advanced and baseline models with latest monthly data"
          # Push the changes back to the main branch
          git push
